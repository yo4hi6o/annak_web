var Jpostal={};Jpostal.Database=function(){this.address=[];this.map={};this.url={http:"//jpostal-1006.appspot.com/json/",https:"//jpostal-1006.appspot.com/json/"}};Jpostal.Database.prototype.find=function(b){var a=[];this.address.forEach(function(c){if(c[0]==="_"+b){a=c}});return a};Jpostal.Database.prototype.get=function(b){var d=["","","","","","","","",""],a,c;switch(b.length){case 3:case 4:case 5:case 6:c=b.substr(0,3);a=this.find(c);a=$.extend(d,a);break;case 7:a=this.find(b);if(a.length===0){c=b.substr(0,3);a=this.find(c)}a=$.extend(d,a);break;default:a=d;break}return a};Jpostal.Database.prototype.getUrl=function(b){var a="";switch(this.getProtocol()){case"http:":a=this.url.http;break;case"https:":a=this.url.https;break}a=a+b+".json";return a};Jpostal.Database.prototype.request=function(a,e){var d,c,b;d=a.substr(0,3);if(a.length<=2||this.getStatus(d)!=="none"||d.match(/\D/)){return false}this.setStatus(d,"waiting");c=this.getUrl(d);b={async:false,dataType:"jsonp",jsonpCallback:"jQuery_jpostal_callback",type:"GET",url:c,success:function(){e()},timeout:5000};this.ajax(b);return true};Jpostal.Database.prototype.ajax=function(a){$.ajax(a)};Jpostal.Database.prototype.save=function(a){var b=this;a.forEach(function(d){var c=d[0];if(b.map[c]===undefined){b.address.push(d);b.map[c]={state:"complete",time:0}}else{if(b.map[c].state==="waiting"){b.address.push(d);b.map[c].state="complete"}}})};Jpostal.Database.prototype.getStatus=function(b){var d="",c="_"+b,a;if(this.map[c]===undefined){d="none"}else{if("complete"===this.map[c].state){d="complete"}else{a=this.getTime()-this.map[c].time;if(a<5000){d="waiting"}else{d="none"}}}return d};Jpostal.Database.prototype.setStatus=function(a){var b="_"+a;if(this.map[b]===undefined){this.map[b]={state:"waiting",time:0}}this.map[b].time=this.getTime()};Jpostal.Database.prototype.getProtocol=function(){return window.location.protocol};Jpostal.Database.prototype.getTime=function(){return(new Date()).getTime()};(function(){var a;Jpostal.Database.getInstance=function(){if(a===undefined){a=new Jpostal.Database()}return a}}());Jpostal.Jpostal=function(a){this.address="";this.jposDb=a;this.options={};this.postcode="";this.minLen=3};Jpostal.Jpostal.prototype.displayAddress=function(){var a=this;if(this.postcode==="000info"){this.address[2]+=" "+this.getScriptSrc()}Object.keys(this.options.address).forEach(function(b){var d=a.options.address[b],c=a.formatAddress(d,a.address);if(a.isSelectTagForPrefecture(b,d)){a.setSelectTagForPrefecture(b,c)}else{$(b).val(c)}})};Jpostal.Jpostal.prototype.isSelectTagForPrefecture=function(c,a){var b;switch(a){case"%3":case"%p":case"%prefecture":if($(c).get(0).tagName.toUpperCase()==="SELECT"){b=true}else{b=false}break;default:b=false;break}return b};Jpostal.Jpostal.prototype.setSelectTagForPrefecture=function(d,a){var c,b;$(d).val(a);if($(d).val()===a){return}c="";b=$(d)[0];Object.keys(b.options).forEach(function(e){var f=String(b.options[e].text).indexOf(a);if(0<=f){c=b.options[e].value}});if(c!==""){$(d).val(c)}};Jpostal.Jpostal.prototype.formatAddress=function(c,a){var b=c;b=b.replace(/%3|%p|%prefecture/,a[1]);b=b.replace(/%4|%c|%city/,a[2]);b=b.replace(/%5|%t|%town/,a[3]);b=b.replace(/%6|%a|%address/,a[4]);b=b.replace(/%7|%n|%name/,a[5]);b=b.replace(/%8/,a[6]);b=b.replace(/%9/,a[7]);b=b.replace(/%10/,a[8]);return b};Jpostal.Jpostal.prototype.getScriptSrc=function(){var d="",a,b,e,c;a=document.getElementsByTagName("script");e=a.length;for(b=0;b<e;b+=1){c=a[b].src;if(0<=c.indexOf("jquery.jpostal.js")){d=c;break}}return d};Jpostal.Jpostal.prototype.init=function(a){if(a.postcode===undefined){throw new Error("postcode undefined")}if(a.address===undefined){throw new Error("address undefined")}this.options.postcode=[];if(typeof a.postcode==="string"){this.options.postcode.push(a.postcode)}else{this.options.postcode=a.postcode}this.options.address=a.address;if(a.url!==undefined){this.jposDb.url=a.url}};Jpostal.Jpostal.prototype.main=function(){var a,b;this.scanPostcode();if(this.postcode.length<this.minLen){return}a=this;b=this.jposDb.request(this.postcode,function(){a.callback()});if(!b){this.callback()}};Jpostal.Jpostal.prototype.callback=function(){this.address=this.jposDb.get(this.postcode);this.displayAddress()};Jpostal.Jpostal.prototype.scanPostcode=function(){var c="",b,a;switch(this.options.postcode.length){case 0:break;case 1:c=String($(this.options.postcode[0]).val());if(0<=c.search(/^([0-9]{3})([0-9A-Za-z]{4})/)){c=c.substr(0,7)}else{if(0<=c.search(/^([0-9]{3})-([0-9A-Za-z]{4})/)){c=c.substr(0,3)+c.substr(4,4)}else{if(0<=c.search(/^([0-9]{3})/)){c=c.substr(0,3)}else{c=""}}}break;case 2:b=String($(this.options.postcode[0]).val());a=String($(this.options.postcode[1]).val());if(0<=b.search(/^[0-9]{3}$/)){if(0<=a.search(/^[0-9A-Za-z]{4}$/)){c=b+a}else{c=b}}else{c=""}break}this.postcode=c};var jQuery_jpostal_callback=function(a){Jpostal.Database.getInstance().save(a)};(function(a){a.fn.jpostal=function(c){var d,b;d=new Jpostal.Jpostal(Jpostal.Database.getInstance());d.init(c);if(typeof c.click==="string"&&c.click!==""){a(c.click).bind("click",function(){d.main()})}else{b=d.options.postcode[0];a(b).bind("keyup change",function(){d.main()});if(1<=d.options.postcode.length){b=d.options.postcode[1];a(b).bind("keyup change",function(){d.main()})}}}}(jQuery));